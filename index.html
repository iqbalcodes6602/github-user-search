<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub User Search</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        crossorigin="anonymous" />
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="user-card.css">
    <link rel="stylesheet" href="repos.css">
    <link rel="stylesheet" href="pagianaion.css">
    <link rel="stylesheet" href="header.css">
</head>

<body>

    <div class="user-search-header">
        <img src="./logo.png" alt="GitHub Logo" />
        <label for="username">Enter GitHub Username</label>
        <input type="text" id="username" placeholder="username..." />
        <button onclick="searchUser()">Search</button>
    </div>

    <div id="userDetails" class="user-details"></div>

    <div class="page-ops" id="page-ops">
        <div>
            <label for="repoSearch">Search Repositories:</label>
            <input type="text" id="repoSearch" oninput="searchRepos()" placeholder="Type repository name">
        </div>
        <div>
            <label for="reposPerPage">Repos per page:</label>
            <select id="reposPerPage" onchange="searchUser()">
                <option value="10" selected>10</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </div>
    </div>

    <div id="reposList"></div>
    <div id="pagination" class="pagination"></div>

    <script>
        const baseURL = "https://api.github.com";

        async function searchUser() {
            const username = document.getElementById("username").value;
            const reposPerPage = document.getElementById("reposPerPage").value;
            const userDetailsElement = document.getElementById("userDetails");
            const reposListElement = document.getElementById("reposList");
            const paginationElement = document.getElementById("pagination");

            // Clear previous results and display loading text
            userDetailsElement.innerHTML = "<img class='laoding-image' src='./loading.svg' />";
            reposListElement.innerHTML = "";
            paginationElement.innerHTML = "";
            
            userDetailsElement.scrollIntoView({ behavior: 'smooth' });

            try {
                // Fetch user details
                const userData = await fetchUserDetails(username);

                // Fetch user repositories
                const reposData = await fetchUserRepos(username);

                // Display user details
                userDetailsElement.innerHTML = `
                <div class="user-card">
                    <div class="user-left">
                        <h2>${userData.login}</h2>
                        <p><strong>Name:</strong> ${userData.name || 'N/A'}</p>
                        <p><strong>Followers:</strong> ${userData.followers}</p>
                        <p><strong>Following:</strong> ${userData.following}</p>
                        <p><strong>Following:</strong> ${userData.following}</p>
                    </div>
                    <div class="user-img">
                        <img src="${userData.avatar_url}" alt="User Avatar">
                    </div>
                </div>
        `;

                // Display repositories (pagination)
                const totalPages = Math.ceil(userData.public_repos / reposPerPage);

                let currentPage = 1;
                displayRepos(currentPage);

                // Display pagination buttons
                const preButton = document.createElement("button");
                preButton.innerText = "Prev";
                preButton.addEventListener("click", () => displayRepos(currentPage - 1));
                paginationElement.appendChild(preButton);
                for (let i = 1; i <= totalPages; i++) {
                    const button = document.createElement("button");
                    button.innerText = i;
                    button.addEventListener("click", () => displayRepos(i));
                    paginationElement.appendChild(button);
                }
                document.getElementById("page-ops").setAttribute("class", "page-ops-show")
                const nextButton = document.createElement("button");
                nextButton.innerText = "Next";
                nextButton.addEventListener("click", () => displayRepos(currentPage + 1));
                paginationElement.appendChild(nextButton);

                async function displayRepos(page) {
                    if (page < 1 || page > totalPages) {
                        return;
                    }
                    // Display loading text during API call
                    reposListElement.innerHTML = "<img class='laoding-image' src='./loading.svg' />";

                    currentPage = page;
                    const response = await fetch(`${baseURL}/users/${username}/repos?page=${page}&per_page=${reposPerPage}`);
                    const reposToShow = await response.json();

                    // Filter repos based on search input
                    const searchTerm = document.getElementById("repoSearch").value.toLowerCase();
                    const filteredRepos = searchTerm
                        ? reposToShow.filter(repo => repo.name.toLowerCase().includes(searchTerm))
                        : reposToShow;

                    reposListElement.innerHTML = filteredRepos.map((repo, index) => `
                    <a href="https://github.com/${username}/${repo.name}" target="_blank">
                        <div class="repo-card">
                            <h3>${repo.name}</h3>
                            <p><strong>Description:</strong> ${repo.description ? repo.description : 'No description available'}</p>
                            <p><strong>Language:</strong> ${repo.language ? repo.language : 'N/A'} &nbsp;&nbsp;&nbsp; ${repo.private ? '<strong><i class="fas fa-lock"></i></strong> Private' : '<strong><i class="fas fa-globe"></i></strong> Public'} &nbsp;&nbsp;&nbsp; ${repo.fork ? '<strong><i class="fas fa-code-branch"></i></strong> Yes' : '<strong><i class="fas fa-code-branch"></i></strong> No'} &nbsp;&nbsp;&nbsp; <strong><i class="fas fa-star"></i></strong> ${repo.stargazers_count}</p>
                        </div>
                    </a>
                `).join("");
                }

            } catch (error) {
                userDetailsElement.innerHTML = "No user found.";
                console.error("Error fetching data:", error);
            }
        }

        async function fetchUserDetails(username) {
            const response = await fetch(`${baseURL}/users/${username}`);
            return response.json();
        }

        async function fetchUserRepos(username) {
            const response = await fetch(`${baseURL}/users/${username}/repos`);
            return response.json();
        }

        function searchRepos() {
            // Trigger search when the user types in the search input
            searchUser();
        }
    </script>

</body>

</html>